好的，这是一个使用 pytest 框架为你的 Flask 应用生成单元测试的示例。  请确保安装 pytest 和 Flask (如果尚未安装):

```bash
pip install pytest flask
```

**1. 创建 `test_todo.py` 文件:**

将以下代码复制到名为 `test_todo.py` 的文件中，与你的 Flask 应用在同一目录下。

```python
import unittest
import pytest
from flask import Flask, request, jsonify
from flask.testing import FlaskClient
from your_script_name import app, get_db, TodoManager, authenticate, init_db
import sqlite3
from datetime import datetime

# 为了简化测试，禁用一些 Flask 调试功能
app.config['TESTING'] = True
app.config['DEBUG'] = False  # 确保在测试时禁用调试模式

# Helper function to create a test database
def create_test_db():
    with app.app_context():
        init_db()

# Helper function to get a database connection
def get_test_db():
    with app.app_context():
        return get_db()

# 创建测试数据库
create_test_db()

# 测试用户认证
def test_authenticate():
    assert authenticate('testuser', 'password') is True
    assert authenticate('wronguser', 'wrongpassword') is False

# 测试 TodoManager 类
def test_create_todo():
    db = get_test_db()
    todo_manager = TodoManager(db)
    user_id = 1
    title = "Test Todo"
    todo_id = todo_manager.create_todo(user_id, title)
    assert isinstance(todo_id, int)
    assert todo_id > 0

    # Verify the todo was actually inserted
    cursor = db.cursor()
    cursor.execute("SELECT * FROM todos WHERE user_id = ? AND title = ?", (user_id, title))
    result = cursor.fetchone()
    assert result is not None
    assert result[1] == user_id
    assert result[2] == title


def test_get_all_todos():
    db = get_test_db()
    todo_manager = TodoManager(db)

    # Create some test todos
    todo_manager.create_todo(1, "Todo 1")
    todo_manager.create_todo(1, "Todo 2")
    todos = todo_manager.get_all_todos(1, page=1, page_size=10)
    assert len(todos['todos']) == 2
    assert todos['total_count'] == 2

def test_get_todo_by_id():
    db = get_test_db()
    todo_manager = TodoManager(db)
    todo_id = todo_manager.create_todo(1, "Test Todo")
    todo = todo_manager.get_todo_by_id(todo_id)
    assert todo is not None
    assert todo[0] == todo_id
    assert todo[2] == 'Test Todo'

def test_update_todo():
    db = get_test_db()
    todo_manager = TodoManager(db)
    todo_id = todo_manager.create_todo(1, "Old Title")
    rows_affected = todo_manager.update_todo(todo_id, title="New Title")
    assert rows_affected == 1

    updated_todo = todo_manager.get_todo_by_id(todo_id)
    assert updated_todo[2] == "New Title"

def test_delete_todo():
    db = get_test_db()
    todo_manager = TodoManager(db)
    todo_id = todo_manager.create_todo(1, "Todo to delete")
    rows_affected = todo_manager.delete_todo(todo_id)
    assert rows_affected == 1

    # Verify todo was actually deleted
    cursor = db.cursor()
    cursor.execute("SELECT * FROM todos WHERE id = ?", (todo_id,))
    result = cursor.fetchone()
    assert result is None

# 测试 API 接口 (需要 Flask 测试客户端)
@pytest.fixture
def test_client():
    with app.test_client() as client:
        yield client

def test_create_todo_api(test_client):
    response = test_client.post('/todos', json={'username': 'testuser', 'password': 'password', 'title': 'Test Todo'})
    assert response.status_code == 201
    assert response.json['title'] == 'Test Todo'

def test_get_all_todos_api(test_client):
    response = test_client.get('/todos?username=testuser&password=password')
    assert response.status_code == 200
    todos = response.json['todos']
    assert len(todos) > 0

def test_update_todo_api(test_client):
    # Create a test todo first
    response = test_client.post('/todos', json={'username': 'testuser', 'password': 'password', 'title': 'Original Title'})
    todo_id = response.json['todo_id']

    # Update the todo
    update_response = test_client.put(f'/todos/{todo_id}', json={'title': 'Updated Title'})
    assert update_response.status_code == 200
    assert update_response.json['rows_affected'] == 1

    # Verify the update
    get_response = test_client.get(f'/todos/{todo_id}')
    assert get_response.json[2] == "Updated Title"
```

**2. 解释说明:**

*   `pytest.fixture`: 用于设置测试环境，例如创建测试数据库和 Flask 测试客户端。
*   `test_client`:  一个 fixture，它返回一个 Flask 测试客户端，方便测试 API 接口。
*   `assert`:  pytest 断言，用于验证测试结果。
*   `create_test_db()`: 在每个测试开始前创建测试数据库，确保测试环境的一致性。
*   数据库操作测试：针对 `TodoManager` 类的所有方法都编写了单元测试，包括创建、获取、更新和删除待办事项。
*   API 接口测试： 使用 `test_client` 测试 API 接口的正确性。

**3. 运行测试:**

在命令行中运行以下命令来执行测试：

```bash
pytest test_todo.py
```

pytest 会自动发现并运行 `test_todo.py` 文件中的所有测试函数。

**4. 重要注意事项:**

*   **替换 `your_script_name`**:  请将 `your_script_name` 替换为你 Flask 应用的实际文件名。
*   **测试数据**:  确保测试数据能够充分覆盖各种场景，包括边界情况和异常情况。
*   **数据库清理**: 在测试完成后，应该清理测试数据库，以避免数据污染。
*   **集成测试**:  除了单元测试，还可以编写集成测试来验证不同模块之间的交互是否正确。
*   **持续集成**:  将测试集成到持续集成流程中，以便在代码更改时自动运行测试。

这个示例提供了一个基本的框架，你可以根据你的具体需求进行修改和完善。记住，良好的测试覆盖率是确保应用程序质量的关键。