# model: gpt-oss:latest
# prompt: <question><template>
  <div class="qna-page">
    <h1>ğŸ¤– æœ¬åœ°AIåŠ©æ‰‹</h1>

    <div class="answer" ref="answerContainer">
      <div v-if="QAHistory.length === 0 && !loading" class="empty-state">
        <div class="empty-icon">ğŸ’¬</div>
        <h3>å¼€å§‹ä½ çš„å¯¹è¯</h3>
        <p>å‘AIåŠ©æ‰‹æé—®ï¼Œè·å¾—æ™ºèƒ½å›ç­”å’Œå»ºè®®</p>
      </div>

      <div v-for="(qa, index) in QAHistory" :key="index" class="qa-item">
        <!-- ç”¨æˆ·é—®é¢˜ -->
        <div class="message-item user">
          <div class="meta">
            <strong>ğŸ‘¤ ä½ </strong>
            <button class="copy-btn" @click="copyMessage(qa.question)" title="å¤åˆ¶é—®é¢˜">å¤åˆ¶</button>
          </div>
          <div class="bubble user-bubble">{{ qa.question }}</div>
        </div>

        <!-- AIå›ç­” -->
        <div class="message-item ai">
          <div class="meta">
            <strong>ğŸ¤– {{ qa.model }}</strong>
            <button class="copy-btn" @click="copyMessage(qa.answer)" title="å¤åˆ¶å›ç­”">å¤åˆ¶</button>
          </div>
          <div class="bubble ai-bubble">
            <div v-if="loading && index === QAHistory.length - 1" class="loading-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <!-- æµå¼æ¸²æŸ“æ—¶æ˜¾ç¤ºåŸå§‹æ–‡æœ¬ï¼Œå®Œæˆåæ˜¾ç¤ºæ ¼å¼åŒ–HTML -->
            <div v-if="index === currentAnswerIndex && isStreaming" class="streaming-text">
              {{ qa.answer }}
              <span class="typing-cursor" v-if="loading">|</span>
            </div>
            <div v-else v-html="getRenderedAnswer(index)" class="answer-content"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- åº•éƒ¨å›ºå®šè¾“å…¥åŒºåŸŸ -->
    <div class="bottom-bar">
      <div class="bar-row">
        <div class="input-area">
          <label>ğŸ¯ ç³»ç»Ÿæç¤ºè¯ (å¯é€‰)</label>
          <textarea v-model="systemPrompt" placeholder="ä¸ºAIæä¾›èƒŒæ™¯ä¿¡æ¯å’Œçº¦æŸæ¡ä»¶..."
            class="question-input system-prompt"></textarea>
        </div>
      </div>

      <div class="bar-row">
        <div class="input-area">
          <label>ğŸ’¬ è¯·è¾“å…¥ä½ çš„é—®é¢˜</label>
          <textarea v-model="question" placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜..." class="question-input main-input"
            @keydown.enter.exact.prevent="askQuestion" @keydown.enter.shift.exact="handleShiftEnter"
            ref="questionTextarea"></textarea>
        </div>
      </div>

      <div class="bar-row">
        <div class="input-area">
          <select v-model="selectedModel" class="model-select">
            <option v-for="model in modelList" :key="model" :value="model">{{ model }}</option>
          </select>

          <button @click="askQuestion" :disabled="loading || !question.trim()" class="submit-btn">
            <span v-if="loading" class="loading-spinner"></span>
            {{ loading ? 'æ€è€ƒä¸­...' : 'å‘é€' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
// Vue å“åº”å¼ API
import { ref, computed, watch, nextTick, onMounted, onUnmounted } from 'vue'
// markdown è§£æåº“
import { marked } from 'marked'
// ä»£ç é«˜äº®åº“
import hljs from 'highlight.js'
// ä»£ç é«˜äº®æ ·å¼
import 'highlight.js/styles/github.css'
// XSSä¿æŠ¤
import DOMPurify from 'dompurify'

// å“åº”å¼çŠ¶æ€
const question = ref('')
const systemPrompt = ref('')
const loading = ref(false)
const selectedModel = ref('')
const modelList = ref([])
const QAHistory = ref([])
const questionTextarea = ref(null)
const answerContainer = ref(null)
const isStreaming = ref(false) // æ–°å¢ï¼šæµå¼æ¸²æŸ“çŠ¶æ€
const currentAnswerIndex = ref(-1) // æ–°å¢ï¼šå½“å‰æ­£åœ¨æµå¼å›ç­”çš„ç´¢å¼•

// SSE äº‹ä»¶æºå¯¹è±¡
let eventSource = null

// é…ç½® marked æ”¯æŒä»£ç é«˜äº®
marked.setOptions({
  highlight: function (code, lang) {
    if (lang && hljs.getLanguage(lang)) {
      return hljs.highlight(code, { language: lang }).value
    }
    return hljs.highlightAuto(code).value
  },
  breaks: true,
  gfm: true
})

// è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
function adjustTextareaHeight() {
  const textarea = questionTextarea.value
  if (textarea) {
    textarea.style.height = 'auto'
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px'
  }
}

// ç›‘å¬é—®é¢˜è¾“å…¥å˜åŒ–ï¼Œè‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
watch(question, () => {
  nextTick(() => {
    adjustTextareaHeight()
  })
})


// å¤„ç†Shift+Enteræ¢è¡Œ
function handleShiftEnter(event) {
  // å…è®¸é»˜è®¤æ¢è¡Œè¡Œä¸º
  nextTick(() => {
    adjustTextareaHeight()
  })
}

// å¤åˆ¶æ¶ˆæ¯åŠŸèƒ½
function copyMessage(text) {
  try {
    navigator.clipboard.writeText(text)
    // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
    const toast = document.createElement('div')
    toast.className = 'copy-toast'
    toast.textContent = 'âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'
    document.body.appendChild(toast)
    setTimeout(() => toast.remove(), 2000)
  } catch (err) {
    console.error('å¤åˆ¶å¤±è´¥:', err)
  }
}

// è·å–æœ€åç­”æ¡ˆ
function getLastAnswer() {
  if (QAHistory.value && QAHistory.value.length === 0) {
    return ''
  }
  const qaTemp = QAHistory.value[QAHistory.value.length - 1]
  return qaTemp.answer
}

// è·å–æ¸²æŸ“ç­”æ¡ˆ
function getRenderedAnswer(index) {
  const qaTemp = QAHistory.value[index]
  if (!qaTemp || !qaTemp.answer) return ''

  // å¯¹äºå½“å‰æ­£åœ¨æµå¼å›ç­”çš„ç´¢å¼•ï¼Œç›´æ¥è¿”å›åŸå§‹æ–‡æœ¬ä»¥æ”¯æŒé€å­—æ˜¾ç¤º
  if (index === currentAnswerIndex.value && isStreaming.value) {
    return qaTemp.answer
  }

  // å¯¹äºå…¶ä»–å·²å®Œæˆçš„å›ç­”ï¼Œè¿”å›æ ¼å¼åŒ–HTML
  const rawHtml = marked.parse(qaTemp.answer)
  const cleanHtml = DOMPurify.sanitize(rawHtml)
  return cleanHtml
}

// è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
function scrollToBottom() {
  nextTick(() => {
    if (answerContainer.value) {
      answerContainer.value.scrollTop = answerContainer.value.scrollHeight
    }
  })
}

// ä»£ç é«˜äº®å‡½æ•°
function highlightCodeBlocks() {
  if (answerContainer.value) {
    try {
      answerContainer.value.querySelectorAll('pre code').forEach(block => {
        if (block.textContent.trim()) {
          hljs.highlightElement(block)
        }
      })
    } catch (error) {
      console.warn('ä»£ç é«˜äº®å¤±è´¥:', error)
    }
  }
}

// ç›‘å¬QAå†å²å˜åŒ–ï¼Œè‡ªåŠ¨æ»šåŠ¨å’Œé«˜äº®ä»£ç 
watch(QAHistory, async () => {
  await nextTick()
  scrollToBottom()

  // åªåœ¨éæµå¼çŠ¶æ€ä¸‹è¿›è¡Œä»£ç é«˜äº®
  if (!isStreaming.value) {
    highlightCodeBlocks()
  }
})

// æäº¤é—®é¢˜ï¼Œæµå¼è·å–ç­”æ¡ˆ
async function askQuestion() {
  if (!question.value.trim()) {
    // ä½¿ç”¨ç°ä»£åŒ–çš„æç¤ºæ–¹å¼æ›¿ä»£alert
    const errorDiv = document.createElement('div')
    errorDiv.className = 'error-toast'
    errorDiv.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„é—®é¢˜'
    document.body.appendChild(errorDiv)
    setTimeout(() => errorDiv.remove(), 3000)
    return
  }

  function getSystemPrompt() {
    if (systemPrompt.value && systemPrompt.value.trim()) {
      return "<system>" + systemPrompt.value.trim() + "</system>\n"
    }
    return ''
  }

  loading.value = true
  isStreaming.value = true // å¼€å§‹æµå¼æ¸²æŸ“

  const qa = {
    question: getSystemPrompt() + "<question>" + question.value + "</question>",
    model: selectedModel.value,
    answer: ''
  }

  QAHistory.value.push(qa)
  currentAnswerIndex.value = QAHistory.value.length - 1 // è®¾ç½®å½“å‰æµå¼å›ç­”ç´¢å¼•

  // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®é«˜åº¦
  question.value = ''
  adjustTextareaHeight()

  // å…³é—­æ—§çš„ SSE è¿æ¥
  if (eventSource) {
    eventSource.close()
  }

  try {
    // ä½¿ç”¨ fetch å…ˆ POSTï¼Œè·å–æµå¼ EventSource é€šé“
    const response = await fetch('/api/chat_start', {
      method: 'post',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: qa.question,
        model: selectedModel.value
      })
    })

    if (!response.ok) throw new Error('æ¥å£è¯·æ±‚å¤±è´¥')

    const streamUrl = await response.text()

    eventSource = new EventSource(streamUrl)

    eventSource.onmessage = (event) => {
      if (event.data === '[DONE]') {
        loading.value = false
        isStreaming.value = false // ç»“æŸæµå¼æ¸²æŸ“
        eventSource.close()

        // æ¸²æŸ“æœ€ç»ˆçš„æ ¼å¼åŒ–å†…å®¹
        nextTick(() => {
          highlightCodeBlocks()
        })

        console.log('æµå¼å“åº”å®Œæˆ')
        return
      }

      try {
        const data = JSON.parse(event.data)
        if (data.text) {
          // é€å­—è¿½åŠ æ–‡æœ¬
          QAHistory.value[currentAnswerIndex.value].answer += data.text
          console.log('æ¥æ”¶åˆ°æ–‡æœ¬:', data.text.substring(0, 20) + '...')

          // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
          nextTick(() => {
            scrollToBottom()
          })
        }
      } catch (e) {
        QAHistory.value[currentAnswerIndex.value].answer += event.data
        console.log('æ¥æ”¶åˆ°åŸå§‹æ•°æ®:', event.data.substring(0, 20) + '...')

        // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        nextTick(() => {
          scrollToBottom()
        })
      }
    }

    eventSource.onerror = () => {
      loading.value = false
      isStreaming.value = false
      eventSource.close()
      QAHistory.value[currentAnswerIndex.value].answer = 'è¿æ¥ä¸­æ–­ï¼Œè¯·é‡è¯•ã€‚'
      console.error('SSEè¿æ¥é”™è¯¯')
    }

    eventSource.addEventListener('end', () => {
      loading.value = false
      isStreaming.value = false
      eventSource.close()
      console.log('SSEæµç»“æŸ')
    })

  } catch (error) {
    loading.value = false
    isStreaming.value = false
    QAHistory.value[currentAnswerIndex.value].answer = 'è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•ã€‚'
    console.error('APIè¯·æ±‚é”™è¯¯:', error)
  }
}

// é¡µé¢åˆå§‹åŒ–æ—¶è·å–æ¨¡å‹åˆ—è¡¨
onMounted(async () => {
  try {
    const res = await fetch('/api/models')
    const data = await res.json()
    modelList.value = data.models || [
      'gpt-oss:20b',
      'deepseek-r1:8b',
      'deepseek-r1:32b',
      'gemma3n:e4b',
      'llama3.1:8b',
      'llama2:latest',
      'gemma2:2b',
      'gemma3:27b'
    ]

    if (modelList.value.length > 0) {
      selectedModel.value = modelList.value[0]
    }
  } catch (e) {
    modelList.value = [
      'gpt-oss:20b',
      'deepseek-r1:8b',
      'deepseek-r1:32b',
      'gemma3n:e4b',
      'llama3.1:8b',
      'llama2:latest',
      'gemma2:2b',
      'gemma3:27b'
    ]
    selectedModel.value = modelList.value[0]
  }
})

// ç¡®ä¿ CSS å˜é‡ --bottom-bar-height ä¸å®é™…åº•éƒ¨æ é«˜åº¦ä¸€è‡´ï¼Œé¿å… overlap
function updateBottomBarHeight() {
  const bar = document.querySelector('.bottom-bar')
  if (bar) {
    const h = bar.offsetHeight
    // è®¾ç½®åœ¨æ ¹ä¸Šï¼Œä»¥è®© scoped CSS è·å–åˆ°è¯¥å˜é‡
    document.documentElement.style.setProperty('--bottom-bar-height', `${h}px`)
  }
}

onMounted(() => {
  updateBottomBarHeight()
  window.addEventListener('resize', updateBottomBarHeight)
})

onUnmounted(() => {
  window.removeEventListener('resize', updateBottomBarHeight)
})
</script>

<style scoped>
/* é¡µé¢æ•´ä½“æ ·å¼ - ç®€æ´è®¾è®¡ */
.qna-page {
  min-height: 100vh;
  width: 100vw;
  box-sizing: border-box;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
  position: relative;
}

.qna-page::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: radial-gradient(circle at 20% 80%, rgba(79, 140, 255, 0.05) 0%, transparent 50%),
    radial-gradient(circle at 80% 20%, rgba(79, 140, 255, 0.05) 0%, transparent 50%);
  pointer-events: none;
}

/* æ ‡é¢˜æ ·å¼ - ç®€çº¦è®¾è®¡ */
h2 {
  margin: var(--spacing-xl) auto var(--spacing-lg);
  font-size: var(--font-size-2xl);
  font-weight: 600;
  color: #1e293b;
  text-align: center;
  position: relative;
  padding-bottom: var(--spacing-sm);
  width: 100%;
  background: linear-gradient(to right, #6366f1, #8b5cf6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

h2::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 60px;
  height: 2px;
  background: linear-gradient(90deg, #6366f1, #8b5cf6);
  border-radius: 2px;
}

/* ç­”æ¡ˆåŒºåŸŸæ ·å¼ - ç®€æ´è®¾è®¡ with fix for scrolling and input area overlap */
.answer {
  width: 90%;
  max-width: 900px;
  flex: 1;
  margin: 0 auto var(--spacing-xl);
  font-size: var(--font-size);
  min-height: 300px;
  /* reserve bottom space so fixed input area doesn't overlap content */
  --bottom-bar-height: 140px;
  max-height: calc(80vh - var(--bottom-bar-height));
  /* Fixed height to enable proper scrolling, accounting for input area */
  background: rgba(255, 255, 255, 0.8);
  border-radius: var(--border-radius-lg);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
  padding: var(--spacing-lg);
  /* extra bottom padding to keep messages above the fixed bottom-bar */
  padding-bottom: calc(var(--spacing-lg) + var(--bottom-bar-height));
  box-sizing: border-box;
  overflow-y: auto;
  position: relative;
  z-index: 1;
  border: 1px solid rgba(148, 163, 184, 0.2);
  backdrop-filter: blur(10px);
  margin-bottom: 20px;
  /* Ensure space for fixed input area */
}

.answer::-webkit-scrollbar {
  width: 8px;
}

.answer::-webkit-scrollbar-track {
  background: rgba(241, 245, 249, 0.5);
  border-radius: 4px;
}

.answer::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
  transition: background var(--transition);
}

.answer::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

/* QAé¡¹ç›®æ ·å¼ - ç®€çº¦è®¾è®¡ */
.qa-item {
  margin-bottom: var(--spacing-lg);
  opacity: 0;
  animation: fadeInUp 0.3s ease-out forwards;
}

.qa-item:nth-child(1) {
  animation-delay: 0.05s;
}

.qa-item:nth-child(2) {
  animation-delay: 0.1s;
}

.qa-item:nth-child(3) {
  animation-delay: 0.15s;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }

  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* æ¶ˆæ¯é¡¹æ ·å¼ - æ›´ç®€æ´ with fix for overlapping */
.message-item {
  margin-bottom: var(--spacing-lg);
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
  width: 100%;
  align-self: stretch;
  /* Ensure full width allocation */
}

.message-item.user {
  align-items: flex-start;
}

.message-item.ai {
  align-items: flex-end;
}

.meta {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--spacing-sm);
  font-size: var(--font-size-sm);
  font-weight: 600;
  color: #64748b;
}

.copy-btn {
  background: none;
  border: 1px solid #e2e8f0;
  border-radius: var(--border-radius);
  padding: var(--spacing-xs) var(--spacing-sm);
  font-size: var(--font-size-xs);
  color: #64748b;
  cursor: pointer;
  transition: all var(--transition);
}

.copy-btn:hover {
  background: #f1f5f9;
  color: #475569;
  border-color: #cbd5e1;
}

/* æ°”æ³¡æ ·å¼ - ç®€çº¦ç°ä»£ with fix for overlapping */
.bubble {
  display: inline-block;
  max-width: 100%;
  padding: var(--spacing);
  border-radius: var(--border-radius-lg);
  position: relative;
  word-wrap: break-word;
  line-height: 1.6;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  animation: fadeIn 0.2s ease-out;
  min-width: 200px;
  /* Ensure minimum width for readability */
  width: 100%;
  box-sizing: border-box;
}

.user-bubble {
  background: #eff6ff;
  border: 1px solid #dbeafe;
  color: #1e40af;
  border-bottom-right-radius: var(--border-radius-sm);
  align-self: flex-start;
  max-width: 85%;
  /* Limit width to prevent overlapping */
}

.ai-bubble {
  background: #f8fafc;
  border: 1px solid #e2e8f0;
  color: #334155;
  border-bottom-left-radius: var(--border-radius-sm);
  align-self: flex-end;
  max-width: 85%;
  /* Limit width to prevent overlapping */
}

/* Answer content styling to fix markdown rendering */
.answer-content {
  width: 100%;
  line-height: 1.6;
  word-wrap: break-word;
}

@keyframes fadeIn {
  from {
    opacity: 0.7;
  }

  to {
    opacity: 1;
  }
}

/* åŠ è½½çŠ¶æ€æ ·å¼ */
.loading {
  display: inline-block;
  padding: var(--spacing-sm) var(--spacing);
  background: var(--warning-color);
  color: var(--text-white);
  border-radius: var(--border-radius);
  font-size: var(--font-size-sm);
  animation: pulse 1.5s ease-in-out infinite;
}

/* è¾“å…¥åŒºåŸŸæ ·å¼ - ç®€çº¦è®¾è®¡ */
.input-area {
  width: 100%;
  display: flex;
  flex-direction: column;
  gap: var(--spacing-xs);
  margin: 0;
  padding: 0;
  background: transparent;
  border: none;
  box-shadow: none;
}

.input-area label {
  font-size: var(--font-size-sm);
  font-weight: 600;
  color: #475569;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
}

/* è¾“å…¥æ¡†æ ·å¼ - ç®€çº¦è®¾è®¡ */
.question-input {
  width: 100%;
  padding: var(--spacing-md);
  font-size: var(--font-size);
  border-radius: var(--border-radius);
  border: 1px solid #cbd5e1;
  background: white;
  resize: vertical;
  min-height: 60px;
  max-height: 200px;
  font-family: inherit;
  transition: all var(--transition);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.question-input:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  transform: translateY(-1px);
}

.question-input::placeholder {
  color: #94a3b8;
  font-style: normal;
}

/* æ¨¡å‹é€‰æ‹©æ ·å¼ - ç®€çº¦è®¾è®¡ */
.model-select {
  padding: var(--spacing-md);
  font-size: var(--font-size);
  border-radius: var(--border-radius);
  border: 1px solid #cbd5e1;
  background: white;
  cursor: pointer;
  transition: all var(--transition);
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
  min-height: 50px;
}

.model-select:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  transform: translateY(-1px);
}

/* æŒ‰é’®æ ·å¼ - ç®€çº¦ç°ä»£ */
.submit-btn {
  padding: var(--spacing-md) var(--spacing-xl);
  font-size: var(--font-size);
  font-weight: 600;
  border-radius: var(--border-radius);
  background: linear-gradient(to right, #6366f1, #8b5cf6);
  border: none;
  color: white;
  cursor: pointer;
  transition: all var(--transition);
  box-shadow: 0 4px 6px rgba(99, 102, 241, 0.3);
  position: relative;
  overflow: hidden;
  min-width: 100px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: var(--spacing-sm);
}

.submit-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(99, 102, 241, 0.4);
}

.submit-btn:active:not(:disabled) {
  transform: translateY(0);
}

.submit-btn:disabled {
  background: #cbd5e1;
  color: #64748b;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

/* åŠ è½½åŠ¨ç”» */
.loading-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid transparent;
  border-top: 2px solid currentColor;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}

/* Markdownå†…å®¹æ ·å¼ä¼˜åŒ– - Enhanced for better rendering */
.answer :deep(.answer-content p) {
  margin: var(--spacing-sm) 0;
  line-height: 1.7;
  color: #334155;
}

.answer :deep(.answer-content pre) {
  background: #f1f5f9;
  border-radius: var(--border-radius);
  padding: var(--spacing);
  margin: var(--spacing-sm) 0;
  overflow-x: auto;
  border: 1px solid #e2e8f0;
  border-left: 3px solid #6366f1;
  white-space: pre-wrap;
  word-wrap: break-word;
}

.answer :deep(.answer-content code) {
  background: #f8fafc;
  padding: 2px 6px;
  border-radius: var(--border-radius-sm);
  font-family: var(--font-mono);
  font-size: var(--font-size-sm);
  color: #475569;
  overflow-x: auto;
}

.answer :deep(.answer-content pre code) {
  background: none;
  padding: 0;
  border: none;
  color: #334155;
  display: block;
  white-space: pre-wrap;
}

.answer :deep(.answer-content h1),
.answer :deep(.answer-content h2),
.answer :deep(.answer-content h3),
.answer :deep(.answer-content h4),
.answer :deep(.answer-content h5),
.answer :deep(.answer-content h6) {
  margin: var(--spacing) 0 var(--spacing-sm);
  color: #1e293b;
  font-weight: 600;
  line-height: 1.4;
}

.answer :deep(.answer-content h1) {
  font-size: var(--font-size-xl);
}

.answer :deep(.answer-content h2) {
  font-size: var(--font-size-lg);
}

.answer :deep(.answer-content h3) {
  font-size: var(--font-size-base);
}

.answer :deep(.answer-content ul),
.answer :deep(.answer-content ol) {
  margin: var(--spacing-sm) 0;
  padding-left: var(--spacing-lg);
  line-height: 1.6;
}

.answer :deep(.answer-content li) {
  margin: var(--spacing-xs) 0;
  line-height: 1.6;
}

.answer :deep(.answer-content blockquote) {
  border-left: 3px solid #6366f1;
  padding-left: var(--spacing);
  margin: var(--spacing-sm) 0;
  font-style: italic;
  color: #64748b;
  background: #f8fafc;
  padding: var(--spacing-sm) var(--spacing);
  border-radius: var(--border-radius-sm);
}

.answer :deep(.answer-content table) {
  width: 100%;
  border-collapse: collapse;
  margin: var(--spacing-sm) 0;
  border: 1px solid #e2e8f0;
  display: block;
  overflow-x: auto;
}

.answer :deep(.answer-content th),
.answer :deep(.answer-content td) {
  border: 1px solid #e2e8f0;
  padding: var(--spacing-sm);
  text-align: left;
}

.answer :deep(.answer-content th) {
  background: #f1f5f9;
  font-weight: 600;
}

/* åº•éƒ¨å›ºå®šå®¹å™¨ - ç®€çº¦è®¾è®¡ with fix to prevent overlap */
.bottom-bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: var(--spacing-md) var(--spacing-lg);
  border-top: 1px solid #e2e8f0;
  box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
  z-index: 100;
  flex-direction: column;
  gap: var(--spacing-sm);
  --bottom-bar-height: 120px;
  min-height: var(--bottom-bar-height);
  /* Set minimum height for the input area */
}

.bottom-bar .bar-row {
  width: 80%;
  max-width: 900px;
  margin: 0 auto;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  gap: var(--spacing);
}

/* ç³»ç»Ÿæç¤ºåˆ‡æ¢æŒ‰é’® */
.toggle-btn {
  background: #b0bdca;
  border: 1px solid #cbd5e1;
  border-radius: var(--border-radius);
  padding: var(--spacing-sm) var(--spacing);
  font-size: var(--font-size-sm);
  color: #64748b;
  cursor: pointer;
  transition: all var(--transition);
  align-self: flex-start;
  min-height: 50px;
}

.toggle-btn:hover {
  background: #e2e8f0;
  color: #475569;
}

/* æµå¼æ–‡æœ¬æ ·å¼ */
.streaming-text {
  width: 100%;
  white-space: pre-wrap;
  word-wrap: break-word;
  line-height: 1.6;
  font-family: inherit;
  font-size: var(--font-size);
  color: #334155;
  background: transparent;
  min-height: 1.2em;
}

.typing-cursor {
  color: #6366f1;
  font-weight: bold;
  animation: blink 1s infinite;
  margin-left: 2px;
}

@keyframes blink {

  0%,
  50% {
    opacity: 1;
  }

  51%,
  100% {
    opacity: 0;
  }
}

/* æµå¼å†…å®¹è¿‡æ¸¡åŠ¨ç”» */
.streaming-text {
  animation: fadeIn 0.1s ease-in;
}

@keyframes fadeIn {
  from {
    opacity: 0.7;
  }

  to {
    opacity: 1;
  }
}

.loading-dots {
  display: flex;
  gap: 4px;
  padding: var(--spacing-sm);
  align-items: center;
}

.loading-dots span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: #6366f1;
  animation: dotPulse 1.4s ease-in-out infinite;
}

.loading-dots span:nth-child(1) {
  animation-delay: 0s;
}

.loading-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.loading-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes dotPulse {

  0%,
  80%,
  100% {
    transform: scale(0.8);
    opacity: 0.5;
  }

  40% {
    transform: scale(1);
    opacity: 1;
  }
}

/* ç©ºçŠ¶æ€æ ·å¼ - ç®€çº¦ç°ä»£ */
.empty-state {
  text-align: center;
  padding: var(--spacing-xxl) var(--spacing-lg);
  color: #64748b;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  gap: var(--spacing);
}

.empty-icon {
  font-size: 3rem;
  margin-bottom: var(--spacing-sm);
  opacity: 0.5;
  color: #94a3b8;
}

.empty-state h3 {
  font-size: var(--font-size-lg);
  font-weight: 600;
  color: #1e293b;
  margin: 0 0 var(--spacing-xs);
}

.empty-state p {
  font-size: var(--font-size);
  color: #64748b;
  margin: 0;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .qna-page {
    padding: 0;
  }

  .answer {
    width: calc(100% - 2 * var(--spacing-lg));
    margin: 0 auto var(--spacing-lg);
    padding: var(--spacing);
  }

  .bottom-bar .bar-row {
    flex-direction: column;
    align-items: stretch;
  }

  .bar-row .input-area {
    gap: var(--spacing-xs);
  }

  .input-area label {
    font-size: var(--font-size-sm);
  }

  h2 {
    font-size: var(--font-size-xl);
    margin: var(--spacing-lg) auto var(--spacing);
  }
}

@media (max-width: 480px) {
  .bottom-bar {
    padding: var(--spacing-sm) var(--spacing);
    --bottom-bar-height: 180px;
  }

  .answer {
    padding: var(--spacing-sm);
  }

  .bubble {
    padding: var(--spacing-sm);
  }

  .submit-btn {
    padding: var(--spacing-sm) var(--spacing);
  }
}
</style> æŒ‰ç…§ chatgptçš„ å¯¹è¯æ¡† ä¼˜åŒ–ä¸€ä¸‹æ ·å¼ï¼Œè¾“å‡ºgit diff æ ¼å¼çš„ä»£ç å˜æ›´</question>
# answer: 
 thinking:

We need to provide git diff with changes to style. So only diff output. We need to optimize chatgpt style dialogs. Likely modify CSS. Provide diff showing changes. We'll assume file name is something like QnAComponent.vue? But we only show diff of CSS part. We'll produce patch. Let's craft modifications: change bubble colors, alignment, use chatgpt look: user bubble blue, AI bubble gray. Use rounded corners, tail. Add tail pseudo-elements. Update .user-bubble and .ai-bubble accordingly. Also adjust .message-item alignment. We'll produce diff.

thinking end 

```diff
--- a/ChatComponent.vue
+++ b/ChatComponent.vue
@@
   .message-item.user {
     align-items: flex-start;
   }
 
   .message-item.ai {
-    align-items: flex-end;
+    align-items: flex-end;
   }
@@
   .user-bubble {
-    background: #eff6ff;
-    border: 1px solid #dbeafe;
-    color: #1e40af;
+    background: #DCF8C6;                /* ChatGPTâ€‘style light green for user */
+    border: none;
     border-bottom-right-radius: var(--border-radius-sm);
     align-self: flex-start;
     max-width: 85%;
   }
 
   .ai-bubble {
-    background: #f8fafc;
-    border: 1px solid #e2e8f0;
-    color: #334155;
+    background: #FFFFFF;                /* Classic chat GPT background */
+    border: none;
     border-bottom-left-radius: var(--border-radius-sm);
     align-self: flex-end;
     max-width: 85%;
   }
+
+  /* Chat bubble tails */
+  .user-bubble::after,
+  .ai-bubble::after {
+    content: "";
+    position: absolute;
+    width: 0;
+    height: 0;
+    border-style: solid;
+  }
+
+  .user-bubble::after {
+    right: -6px;
+    top: 12px;
+    border-width: 8px 0 8px 8px;
+    border-color: transparent transparent transparent #DCF8C6;
+  }
+
+  .ai-bubble::after {
+    left: -6px;
+    top: 12px;
+    border-width: 8px 8px 8px 0;
+    border-color: transparent #FFFFFF transparent transparent;
+  }
+
+  /* Remove extra borders from bubbles */
+  .user-bubble, .ai-bubble {
+    box-shadow: none;
+  }
+
+  /* Increase bubble padding for better readability */
+  .bubble {
+    padding: calc(var(--spacing) * 1.5) var(--spacing);
+  }
+
+  /* Slightly round bubble corners for a softer look */
+  .user-bubble, .ai-bubble {
+    border-radius: var(--border-radius-lg);
+  }
+
+  /* Align timestamps to the bottom-right of each bubble */
+  .meta {
+    font-size: var(--font-size-xs);
+    color: #9CA3AF;
+    margin-top: 4px;
+  }
+
+  /* Add a subtle hover effect on bubbles */
+  .user-bubble:hover, .ai-bubble:hover {
+    filter: brightness(1.02);
+  }
```

**è¯´æ˜**  
- æ›´æ”¹äº†ç”¨æˆ·ä¸ AI å¯¹è¯æ°”æ³¡çš„èƒŒæ™¯é¢œè‰²ï¼Œä½¿å…¶æ›´è´´è¿‘ ChatGPT çš„è§†è§‰é£æ ¼ã€‚  
- ä¸ºæ°”æ³¡æ·»åŠ äº†â€œå°¾éƒ¨â€ (tail) æ ·å¼ï¼Œæå‡èŠå¤©ä½“éªŒã€‚  
- å»æ‰äº†å¤šä½™è¾¹æ¡†ä¸é˜´å½±ï¼Œç®€åŒ–è§†è§‰æ•ˆæœã€‚  
- è°ƒæ•´äº†æ°”æ³¡å†…è¾¹è·ä¸åœ†è§’ï¼Œæå‡å¯è¯»æ€§ã€‚  
- åœ¨ `.meta` ä¸­åŠ å…¥æ—¶é—´æˆ³æ ·å¼ï¼ˆå¯æ ¹æ®éœ€è¦å¡«å……æ—¶é—´ï¼‰ã€‚  
- æ·»åŠ è½»å¾®çš„æ‚¬åœäº®åº¦æ•ˆæœï¼Œå¢å¼ºäº¤äº’åé¦ˆã€‚  

åªä¿ç•™ä¸ CSS ç›¸å…³çš„æ”¹åŠ¨ï¼Œç¬¦åˆ Git diff æ ¼å¼ã€‚thinking:


